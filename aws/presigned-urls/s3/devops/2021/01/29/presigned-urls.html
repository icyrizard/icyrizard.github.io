<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Notes on setting up AWS S3 Pre-signed URLs - CodeDerps</title>

<meta name="description" content="A while I’ve been working on a project to further upgrade the security for the company that I work for. I still remember some struggles I’ve endured during t...">
<link rel="canonical" href="/aws/presigned-urls/s3/devops/2021/01/29/presigned-urls.html"><link rel="alternate" type="application/rss+xml" title="CodeDerps" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="A collection guides and thoughts about programming, about things I've personally encountered through the years, years of study and working experience.
" href="/">CodeDerps</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/archive.html">Archive</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>Notes on setting up AWS S3 Pre-signed URLs</h1></header><span class="split-space">&nbsp;</span>
          <a class="edit-on-github"
            title="Edit on Github"
            href="https://github.com/icyrizard/icyrizard.github.io/tree/master/_posts/2021-01-29-presigned-urls.markdown">
            <i class="far fa-edit"></i></a></div><meta itemprop="headline" content="Notes on setting up AWS S3 Pre-signed URLs"><div class="article__info clearfix"><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jan 29, 2021</span>
            </li></ul></div><meta itemprop="author" content="Richard Torenvliet"/><meta itemprop="datePublished" content="2021-01-29T19:48:16+01:00"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p>A while I’ve been working on a project to further upgrade the security for the company that I work for. I still 
remember some struggles I’ve endured during the project, both by design and implementation.</p>

<p>This blog post will cover some of my learnings during this project. The examples will be in PHP, while I do have my 
opinion about PHP, but it’s the safest way for me to guarantee that my examples work :).</p>

<h2 id="a-little-background-story">A Little Background Story</h2>
<p>Users directly upload pictures to our Backend Application, during the upload process they are resized into two types of sizes. A thumbnail
size and a preview size. This yields 3 images that will need storing in S3, each will be get a long string of random characters as its new
name in S3 bucket. This should alreayd be fairly secure, there is no way on earth someone could guess the names of these images. Even given the fact that
we store an insane amount of images, our human brain cannot comprehend the size of the search space in which an attacker
has to go through to be very very lucky…</p>

<p>That said, a fair remark I got was:</p>

<blockquote>
  <p><em>“But uhh, what if the paths to the s3 bucket objects were leaked? Won’t they be downloadable forever?”.</em></p>
</blockquote>

<p>This is a truly valid remark, evil forces with the right access pass, will undoubtedly be able to pull something off like this.
So, in short, we need to block public access to our bucket. This can be done by either using Signed or Presigned URLS.</p>

<h2 id="what-are-signed-urls">What are Signed URLS?</h2>
<p>For the Signed URLs mechanism, the backend application will generate URLS that are signed, using a private key for which Cloudfront
has the public key. The link generated will
point towards a CloudFront Distribution that is able to verify the signing hidden in the requests parameters. The benefit
is that you can use Cloudfront and take use of its caching mechanisms as well as protect the resources it has to. It does require root access to the AWS Account,
so depending on your situation, this may be more difficult to implement.</p>

<blockquote>
  <p>More will come</p>
</blockquote>

<h2 id="what-are-pre-signed-urls">What are Pre-signed URLS?</h2>
<p>AWS Pre-signed URLs allow for temporary granting access rights to someone with the link. This being, to rights to either <strong>read</strong>, <strong>write</strong> or <strong>delete</strong>
S3 Objects. From a server side perspective, this could simply mean that we generate the Presigned URL on the server and that link to 
the client. The client can use the URLs to perform the desired operation, depending on the access right granted by the server.</p>

<p>A prerequisites is that the AWS Service needs to have access to the location to the 
Bucket and Path for which it is generating a Pre-signed URL. You can either use an AWS Key and AWS Secret, 
but it’s far more secure and scalable solution to use an Iam Role that is attached to the AWS service of your backend entity in AWS.
To use it, you should use pass <a href="https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_configuration.html">Aws\CacheInterface</a>, 
as the credentials so setup the<code class="language-plaintext highlighter-rouge">S3Client</code>. An example of this is shown in Listings 1.</p>

<p>This will prevent long reuse of an AWS Key and Secret, this reduces the risk of those keys being leaked in any way and be active forever without knowing. 
Role based access will give you full power in what is allowed by that specific role. Another benefit is that is a less expensive operation.</p>

<h2 id="the-goal">The Goal</h2>
<p>In the end, we want users to use a link to our backend server and get automatically redirected to S3 with a presigned url or signed url.
The choice for the current implementation has fallen on the Pre-signed urls. It requires one less entity in the scheme of things,
and we do not need the access to the AWS root account to create a key pair, so for our situation Presigned URLS were our best pick.</p>

<ol>
  <li>The user logs in to our platform</li>
  <li>Retrieves resources and their attachments</li>
  <li>The attachments have links directly leading to our Backend.</li>
  <li>We check if they have a valid login and if they are allowed to see the current requested resource using their access key.</li>
</ol>

<p>The benefits of this method is that the links that are responded by our API can remain the same forever. Only upon downloading / accessing 
that url with the right access credentials, the generation of the Pre-signed URL starts immediately. The HTTP Client automatically is redirected to the right URL.
This means that it is hard for an attacker to find the actual links to images because it must operate within the browser or network,
and record the HTTP <code class="language-plaintext highlighter-rouge">Location Header</code> response of our server to the client. That is what how a the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections">HTTP Redirect</a> 
mechanism actually works.</p>

<h3 id="aws-s3-client-initialization">AWS S3 Client Initialization</h3>
<p>This documentation is a bit misleading on what you should supply as the credentials option for the S3Client:</p>

<p><strong>Copied from the AWS Docs on AWS S3 Client Credentials initialisation:</strong></p>
<blockquote>
  <p>If you don’t provide a credentials option, the SDK attempts to load credentials from your environment in the following order:</p>
  <ol>
    <li>Load credentials from environment variables.</li>
    <li>Load credentials from a credentials .ini file.</li>
    <li>Load credentials from an IAM role.</li>
  </ol>
</blockquote>

<p>But if yoo provide an object of type <code class="language-plaintext highlighter-rouge">Aws\CacheInterface</code>, you will get the AWS Key and Secret that the S3Client that is has gotten itself from the IAM Role. 
The AWS Key and Secret it has retrieved from the 
<a href="https://docs.amazonaws.cn/zh_cn/aws-sdk-php/guide/latest/guide/credentials.html#using-iam-roles-for-amazon-ec2-container-service-tasks">EC2 Service Metadata</a>
, which is retrieved by means of a request. This is obviously slower than if were to store those keys temporarily which can be reused.</p>

<h3 id="getting-an-s3-object-with-a-presigned-url">Getting an S3 Object with a Presigned URL</h3>
<p>Following the Example on the <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/RetrieveObjSingleOpPHP.html">AWS Documentation on PresignedURLs</a>,
and combining this the <code class="language-plaintext highlighter-rouge">Aws\CacheInterface</code>, we get the following
result for retrieving an object using the presigned URL. Note that this not the result we are aiming for yet… we don’t want to
download the object in the Backend, we want to give the sweet task of the downloading the object to the client.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="cd">/**
 * Use get and set to store your credentials in a Cache that can be quickly accessed.
 * 
* Class CacheObject
 */</span>
<span class="kd">class</span> <span class="nc">CacheObject</span> <span class="kd">implements</span> <span class="nc">Aws\CacheInterface</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">set</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$ttl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">remove</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="mf">...</span> 

<span class="nv">$keyName</span> <span class="o">=</span> <span class="s1">'uploads/aaaaaaaaaaaaaaaaaaaaa.jpg'</span><span class="p">;</span>

<span class="nv">$credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CacheObject</span><span class="p">();</span>

<span class="nv">$s3Client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Aws\S3\S3Client</span><span class="p">([</span>
  <span class="s1">'version'</span>     <span class="o">=&gt;</span> <span class="s1">'latest'</span><span class="p">,</span>
  <span class="s1">'region'</span>      <span class="o">=&gt;</span> <span class="s1">'eu-west-1'</span><span class="p">,</span>
  <span class="s1">'credentials'</span> <span class="o">=&gt;</span> <span class="nv">$credentials</span>
<span class="p">]);</span>

<span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$s3Client</span><span class="o">-&gt;</span><span class="nf">getCommand</span><span class="p">(</span><span class="s1">'GetObject'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'Bucket'</span> <span class="o">=&gt;</span> <span class="s1">'derp-bucket'</span><span class="p">,</span>
    <span class="s1">'Key'</span> <span class="o">=&gt;</span> <span class="nv">$keyName</span><span class="p">,</span>
<span class="p">]);</span>

<span class="nv">$request</span> <span class="o">=</span> <span class="nv">$s3Client</span><span class="o">-&gt;</span><span class="nf">createPresignedRequest</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="s1">'+2 minutes'</span><span class="p">);</span>

</code></pre></div></div>
<blockquote>
  <p>Listings 1: Shows an Example of how to get an S3 Object from S3 using a Pre-singed Request.</p>
</blockquote>

<p>This is nice, but we don’t want the actual file, we want the client to fetch it instead. We just need the URL and send
an HTTP Redirect so the client can follow that link instead.</p>

<h3 id="getting-a-presigned-url">Getting a Presigned URL.</h3>
<p>Now remember that the Goal is to redirect the user to the S3 Bucket, after we have checked their login. So we have
to generate the Presigned URL by the following snippet:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$lifetime</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

<span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$s3</span><span class="o">-&gt;</span><span class="nf">getCommand</span><span class="p">(</span><span class="s1">'GetObject'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'Bucket'</span> <span class="o">=&gt;</span> <span class="s1">'derp-bucket'</span><span class="p">,</span>
    <span class="s1">'Key'</span> <span class="o">=&gt;</span> <span class="nv">$keyName</span><span class="p">,</span>
<span class="p">]);</span>

<span class="nv">$presignedUrlRequest</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="no">S3</span><span class="o">-&gt;</span><span class="nf">createPresignedRequest</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nc">DateUtils</span><span class="o">::</span><span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="nv">$lifetime</span><span class="p">);</span>
<span class="nv">$presignedUrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nv">$presignedUrlRequest</span><span class="o">-&gt;</span><span class="nf">getUri</span><span class="p">();</span> 

</code></pre></div></div>
<blockquote>
  <p>Listings 2: Shows an Example of how to get the Pre-signed Url from S3.</p>
</blockquote>

<p>An important part was to cast the result of the getUri function to a String. It returns an object that contains
a toString method. Not converting it will give you hours of fun debugging, you’re welcome :).</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$presignedUrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nv">$presignedUrlRequest</span><span class="o">-&gt;</span><span class="nf">getUri</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="sending-the-redirect-to-the-client">Sending the Redirect to the Client</h3>
<p>Now that we have the URL we can send a 303 to with the location header set to the Presigned URL. The HTTP Client of
the user will automatically follow the redirect and start downloading the S3 Object. Now at this moment a problem arose.
This problem is discussed in the following Section.</p>

<h2 id="how-long-should-the-pre-signed-url-lifetime-be">How long should the Pre-signed URL Lifetime be?</h2>
<p>Talking from own experience (I could definitely be wrong about this), the lifetime of the Pre-signed URL must be around 60 seconds at least.
Any lower will occasionally trigger <code class="language-plaintext highlighter-rouge">Expired</code> errors by S3. This could either be due differences in clocks, or the time difference between getting a fresh new Pre-signed URL and when
the download actually starts can be a cause of an Expired response from S3.</p>

<p>Remind that we’re trying to block the fact that S3 Objects are downloadable forever if you have the link,
a hacker that has obtained the Pre-signed URL somehow can download the Object within the same second of finding it.</p>

<h4 id="the-authorization-header-problem">The Authorization Header Problem</h4>
<p>The <code class="language-plaintext highlighter-rouge">Authorization Header</code> is not usable now. You cannot use the Authorization Header to authenticate the user on your platform
AND send a redirect to AWS. Strangely enough, the Authorization Header is not stripped after a redirect, see <a href="#references">[1]</a>. That’s something I never realized. 
And who would until they find out the hard way right?</p>

<p>Anyway, to prevent this, we go back to our old school Cookie Authorization. So instead of the Authorization Header that contains the acces key, they must use send 
a Cookie to Authorize themselves on our server to get access to S3 Object. A well known fact about Cookies is that they are automatically stripped if the domain changes.</p>

<p>The following Error is given when trying to send the Authorization Header (unknowingly…).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;Error&gt;&lt;Code&gt;</span>InvalidArgument<span class="nt">&lt;/Code&gt;</span>
<span class="nt">&lt;Message&gt;</span>Only one auth mechanism allowed; only the X-Amz-Algorithm query parameter, Signature query string parameter or the Authorization header should be specified<span class="nt">&lt;/Message&gt;</span>
<span class="nt">&lt;ArgumentName&gt;</span>Authorization<span class="nt">&lt;/ArgumentName&gt;</span>
    <span class="nt">&lt;ArgumentValue&gt;</span>Bearer Token<span class="nt">&lt;/ArgumentValue&gt;&lt;RequestId&gt;</span>
<span class="nt">&lt;/RequestId&gt;</span>
    <span class="nt">&lt;HostId&gt;</span>...<span class="nt">&lt;/HostId&gt;</span>
<span class="nt">&lt;/Error&gt;</span>
</code></pre></div></div>
<blockquote>
  <p>Listings 3: Shows the error message received upon the HTTP Redirect where the Authorization Header was not stripped from the request.</p>
</blockquote>

<p>In the Pre-signed URL the X-Amz-Algorithm contains</p>

<h4 id="fix-the-cors-problem">Fix the CORS problem</h4>
<p>Needless to say, this problem needs solving I will state this for the sake of completeness, but for this problem no particular
weirdness happened for me. Lucky me. A small note, for our purpose only the GET method is needed, and restricting the origin is 
impossible and unnecessary. Impossible because our users should be able to use their own scripts to download images.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;CORSConfiguration</span> <span class="na">xmlns=</span><span class="s">"http://s3.amazonaws.com/doc/2006-03-01/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;CORSRule&gt;</span>
        <span class="nt">&lt;AllowedOrigin&gt;</span>*<span class="nt">&lt;/AllowedOrigin&gt;</span>
        <span class="nt">&lt;AllowedMethod&gt;</span>GET<span class="nt">&lt;/AllowedMethod&gt;</span>
        <span class="nt">&lt;MaxAgeSeconds&gt;</span>3000<span class="nt">&lt;/MaxAgeSeconds&gt;</span>
        <span class="nt">&lt;AllowedHeader&gt;</span>*<span class="nt">&lt;/AllowedHeader&gt;</span>
    <span class="nt">&lt;/CORSRule&gt;</span>
<span class="nt">&lt;/CORSConfiguration&gt;</span>
</code></pre></div></div>
<blockquote>
  <p>Listings 4: THe CORS Headers needed for on our S3 Bucket. Enter this XML into the ‘Permissions’ tab -&gt; CORS Section of the S3 Bucket.</p>
</blockquote>

<p>When you use do restrict the S3 bucket to certain domains, it can aid to a higher level of security. When your requirement is to allow access from anywhere to the
S3 bucket, this becomes impossible. That said, the Signed URL version of this using Cloudfront does give you the opportunity to strictly allow
access from that Cloudfront origin.</p>

<h1 id="conclusion">Conclusion</h1>
<p>In these notes I’ve aimed to give an example of how Pre-signed Urls work and how they can be used in a production environment.
I’ve copied and put together some AWS Documentation to make small example of how Pre-signed Urls could
work for an application. We’ve seen an example of how to set up the S3 Client efficiently using the Cache Object, an example
that I haven’t really seen on the AWS Documentation.</p>

<p>We’ve seen the problem that occur when using an HTTP Redirect Request, that it does not strip out the Authorization 
Header after Redirection. In my opinion HTTP Client should really strip those out to prevent any dangerous leakage
of Access Keys. The Authorization Header is the modern version of the Cookie Header, and yet it is less secure considering this.</p>

<h3 id="references">References</h3>
<h4 id="1-how-to-remove-authorization-header-in-a-http-302-response---stack-">1. “How to remove authorization header in a http 302 response - Stack ….”</h4>
<p><a href="https://stackoverflow.com/questions/35400943/how-to-remove-authorization-header-in-a-http-302-response/45217599. Accessed 9 Feb. 2021.">https://stackoverflow.com/questions/35400943/how-to-remove-authorization-header-in-a-http-302-response/45217599. Accessed 9 Feb. 2021.</a></p>

</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2021-01-29T19:48:16+01:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">Subscribe</a></div>
</div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Attribution-NonCommercial 4.0 International" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
</div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Richard Torenvliet"><meta itemprop="url" content="/"><meta itemprop="description" content="MSc Graduated Software Developer and love to talk about code, salsa dancing and photography."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:richard@torenvliet.org" target="_blank">
        <i class="fas fa-envelope"></i>
      </a></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© CodeDerps 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

